# Gas Town convoy lifecycle â€” create, track, close, check, stranded.
#
# Tests the full convoy surface used by deacon to batch-track
# work dispatched across multiple polecats.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# Initialize city
exec gc init $WORK/bright-lights
cd $WORK/bright-lights

# --- 1. Create convoy with no issues ---

exec gc convoy create 'Sprint 42'
stdout 'Created convoy gc-1 "Sprint 42"'

# --- 2. Create issues and add to convoy ---

exec bd create 'Fix login bug'
stdout 'gc-2'
exec bd create 'Add dark mode'
stdout 'gc-3'
exec bd create 'Update docs'
stdout 'gc-4'

exec gc convoy add gc-1 gc-2
stdout 'Added gc-2 to convoy gc-1'

exec gc convoy add gc-1 gc-3
stdout 'Added gc-3 to convoy gc-1'

exec gc convoy add gc-1 gc-4
stdout 'Added gc-4 to convoy gc-1'

# --- 3. Convoy list shows open convoy with progress ---

exec gc convoy list
stdout 'gc-1'
stdout 'Sprint 42'
stdout '0/3 closed'

# --- 4. Convoy status shows details ---

exec gc convoy status gc-1
stdout 'Convoy:   gc-1'
stdout 'Title:    Sprint 42'
stdout 'Status:   open'
stdout 'Progress: 0/3 closed'
stdout 'gc-2'
stdout 'Fix login bug'
stdout 'gc-3'
stdout 'Add dark mode'

# --- 5. Close some issues, progress updates ---

exec bd close gc-2
exec gc convoy status gc-1
stdout 'Progress: 1/3 closed'

exec bd close gc-3
exec gc convoy status gc-1
stdout 'Progress: 2/3 closed'

# --- 6. Stranded detects unassigned open issues ---

exec gc convoy stranded
stdout 'gc-4'
stdout 'Update docs'

# --- 7. Close last issue, convoy check auto-closes ---

exec bd close gc-4
exec gc convoy check
stdout 'Auto-closed convoy gc-1 "Sprint 42"'
stdout '1 convoy.s. auto-closed'

# --- 8. After auto-close, convoy list is empty ---

exec gc convoy list
stdout 'No open convoys'

# --- 9. No stranded work after all closed ---

exec gc convoy stranded
stdout 'No stranded work'

# --- 10. Create convoy with inline issue IDs ---

exec bd create 'Task A'
exec bd create 'Task B'
exec gc convoy create 'Batch' gc-5 gc-6
stdout 'Created convoy gc-7 "Batch" tracking 2 issue'

exec gc convoy status gc-7
stdout 'Progress: 0/2 closed'

# --- 11. Manual convoy close ---

exec gc convoy close gc-7
stdout 'Closed convoy gc-7'

# --- 12. Convoy check with nothing to close ---

exec gc convoy check
stdout '0 convoy.s. auto-closed'

# --- Error paths ---

# Missing convoy name
! exec gc convoy create
stderr 'missing convoy name'

# Missing convoy ID
! exec gc convoy status
stderr 'missing convoy ID'

# Nonexistent convoy
! exec gc convoy status gc-999
stderr 'not found'

# Not a convoy
! exec gc convoy status gc-5
stderr 'not a convoy'

# Missing args for add
! exec gc convoy add
stderr 'usage:'

# Add to nonexistent convoy
! exec gc convoy add gc-999 gc-5
stderr 'not found'

# Missing convoy close ID
! exec gc convoy close
stderr 'missing convoy ID'

# Close nonexistent
! exec gc convoy close gc-999
stderr 'not found'

# Close non-convoy
! exec gc convoy close gc-5
stderr 'not a convoy'

# Missing subcommand
! exec gc convoy
stderr 'missing subcommand'

# Unknown subcommand
! exec gc convoy blorp
stderr 'unknown subcommand "blorp"'
