# Session lifecycle tests with fake session provider.

env GC_SESSION=fake
env GC_BEADS=file
env GC_DOLT=skip

# gc start auto-initializes a new city.
exec gc start $WORK/my-city
stdout 'Welcome to Gas City!'
stdout 'Initialized city'
stdout 'City started.'

# gc start is idempotent — no init message when city already exists.
exec gc start $WORK/my-city
! stdout 'Welcome to Gas City!'
stdout 'City started.'

# gc start with an agent that has start_command — actually exercises sessions.
exec gc start $WORK/cmd-city
stdout 'Started agent'
stdout 'City started.'

# gc stop with path.
exec gc stop $WORK/cmd-city
stdout 'City stopped.'

# gc start with path (city auto-inited above, just starts).
exec gc start $WORK/my-city
stdout 'City started.'

# gc stop with path.
exec gc stop $WORK/my-city
stdout 'City stopped.'

# rig add without git.
cd $WORK/my-city
exec gc rig add $WORK/no-git-project
stdout 'Adding rig'
stdout 'no-git-project'
! stdout 'Detected git repo'

# rig list shows the rig.
exec gc rig list
stdout 'no-git-project:'

# rig add not a directory.
! exec gc rig add $WORK/my-city/city.toml
stderr 'is not a directory'

# rig list when empty (new city).
cd $WORK/empty-city
exec gc rig list
stdout 'Rigs in'

-- no-git-project/README.md --
# No git here
-- cmd-city/.gc/.keep --
-- cmd-city/rigs/.keep --
-- cmd-city/city.toml --
[workspace]
name = "cmd-city"

[[agents]]
name = "mayor"
start_command = "echo hello"
-- empty-city/.gc/.keep --
-- empty-city/rigs/.keep --
-- empty-city/city.toml --
[workspace]
name = "empty-city"

[[agents]]
name = "mayor"
