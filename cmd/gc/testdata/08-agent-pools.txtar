# Agent pool tests with fake session provider.

env GC_SESSION=fake
env GC_BEADS=file
env GC_DOLT=skip

# 1. City with pool (min=0, max=5, scale_check="echo 3") starts 3 agents.
exec gc start $WORK/pool-city
stdout 'Pool .worker.: starting 3 agent'
stdout 'Started agent .worker-1.'
stdout 'Started agent .worker-2.'
stdout 'Started agent .worker-3.'
stdout 'City started.'

# 2. gc pool status shows pool config (fake provider is per-process,
# so sessions from gc start are not visible here).
cd $WORK/pool-city
exec gc pool status
stdout 'Pool .worker.'
stdout 'min=0, max=5'

# 3. City with pool (min=2, scale_check="echo 0") â€” min wins, starts 2.
exec gc start $WORK/min-city
stdout 'Pool .builder.: starting 2 agent'
stdout 'Started agent .builder-1.'
stdout 'Started agent .builder-2.'
stdout 'City started.'

# 4. gc stop on pool city still works.
exec gc stop $WORK/pool-city
stdout 'City stopped.'

# 5. gc pool status with no pools configured.
cd $WORK/no-pool-city
exec gc pool status
stdout 'No pools configured.'

# 6. Mixed agents and pools coexist.
exec gc start $WORK/mixed-city
stdout 'Started agent .mayor.'
stdout 'Pool .worker.: starting 2 agent'
stdout 'Started agent .worker-1.'
stdout 'Started agent .worker-2.'
stdout 'City started.'

exec gc stop $WORK/mixed-city
stdout 'City stopped.'

# 7. gc start is idempotent for pool cities.
exec gc start $WORK/pool-city
stdout 'Pool .worker.: starting 3 agent'
stdout 'City started.'

-- pool-city/.gc/.keep --
-- pool-city/rigs/.keep --
-- pool-city/city.toml --
[workspace]
name = "pool-city"

[[pools]]
name = "worker"
start_command = "echo hello"
min = 0
max = 5
scale_check = "echo 3"

-- min-city/.gc/.keep --
-- min-city/rigs/.keep --
-- min-city/city.toml --
[workspace]
name = "min-city"

[[pools]]
name = "builder"
start_command = "echo hello"
min = 2
max = 10
scale_check = "echo 0"

-- no-pool-city/.gc/.keep --
-- no-pool-city/rigs/.keep --
-- no-pool-city/city.toml --
[workspace]
name = "no-pool-city"

[[agents]]
name = "mayor"
start_command = "echo hello"

-- mixed-city/.gc/.keep --
-- mixed-city/rigs/.keep --
-- mixed-city/city.toml --
[workspace]
name = "mixed-city"

[[agents]]
name = "mayor"
start_command = "echo hello"

[[pools]]
name = "worker"
start_command = "echo hello"
min = 0
max = 5
scale_check = "echo 2"
