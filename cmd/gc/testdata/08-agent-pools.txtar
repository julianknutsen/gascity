# Agent pool tests with fake session provider.

env GC_SESSION=fake
env GC_BEADS=file
env GC_DOLT=skip

# 1. City with pool (min=0, max=5, check="echo 3") starts 3 agents.
exec gc start $WORK/pool-city
stdout 'Started agent .worker-1.'
stdout 'Started agent .worker-2.'
stdout 'Started agent .worker-3.'
stdout 'City started.'

# 2. gc agent list shows pool info inline.
cd $WORK/pool-city
exec gc agent list
stdout 'pool-city:'
stdout 'worker .pool: min=0, max=5.'

# 3. City with pool (min=2, check="echo 0") â€” min wins, starts 2.
exec gc start $WORK/min-city
stdout 'Started agent .builder-1.'
stdout 'Started agent .builder-2.'
stdout 'City started.'

# 4. gc stop on pool city still works.
exec gc stop $WORK/pool-city
stdout 'City stopped.'

# 5. gc agent list with no pools shows simple agents.
cd $WORK/no-pool-city
exec gc agent list
stdout 'no-pool-city:'
stdout '  mayor'

# 6. Mixed agents and pools coexist.
exec gc start $WORK/mixed-city
stdout 'Started agent .mayor.'
stdout 'Started agent .worker-1.'
stdout 'Started agent .worker-2.'
stdout 'City started.'

exec gc stop $WORK/mixed-city
stdout 'City stopped.'

# 7. gc start is idempotent for pool cities.
exec gc start $WORK/pool-city
stdout 'City started.'

# 8. Ephemeral singleton (max=1) uses bare name.
exec gc start $WORK/singleton-city
stdout 'Started agent .refinery.'
stdout 'City started.'

-- pool-city/.gc/.keep --
-- pool-city/rigs/.keep --
-- pool-city/city.toml --
[workspace]
name = "pool-city"

[[agents]]
name = "worker"
start_command = "echo hello"

[agents.pool]
min = 0
max = 5
check = "echo 3"

-- min-city/.gc/.keep --
-- min-city/rigs/.keep --
-- min-city/city.toml --
[workspace]
name = "min-city"

[[agents]]
name = "builder"
start_command = "echo hello"

[agents.pool]
min = 2
max = 10
check = "echo 0"

-- no-pool-city/.gc/.keep --
-- no-pool-city/rigs/.keep --
-- no-pool-city/city.toml --
[workspace]
name = "no-pool-city"

[[agents]]
name = "mayor"
start_command = "echo hello"

-- mixed-city/.gc/.keep --
-- mixed-city/rigs/.keep --
-- mixed-city/city.toml --
[workspace]
name = "mixed-city"

[[agents]]
name = "mayor"
start_command = "echo hello"

[[agents]]
name = "worker"
start_command = "echo hello"

[agents.pool]
min = 0
max = 5
check = "echo 2"

-- singleton-city/.gc/.keep --
-- singleton-city/rigs/.keep --
-- singleton-city/city.toml --
[workspace]
name = "singleton-city"

[[agents]]
name = "refinery"
start_command = "echo hello"

[agents.pool]
min = 0
max = 1
check = "echo 1"
