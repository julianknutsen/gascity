# Controller mode tests with fake session provider.

env GC_SESSION=fake
env GC_BEADS=file
env GC_DOLT=skip

# gc start --controller runs the persistent loop and can be stopped.
exec gc start --controller $WORK/ctrl-city &ctrl&
exec sleep 1

# gc stop connects to the controller socket and asks it to shut down.
exec gc stop $WORK/ctrl-city
stdout 'Controller stopping'

# Wait for the controller to finish.
wait ctrl
stdout 'Controller started.'
stdout 'Controller stopped.'

# Double-start: start one controller, try to start another.
exec gc start --controller $WORK/ctrl-city &ctrl2&
exec sleep 1

! exec gc start --controller $WORK/ctrl-city
stderr 'controller already running'

# Clean up the first controller.
exec gc stop $WORK/ctrl-city
wait ctrl2

-- ctrl-city/.gc/.keep --
-- ctrl-city/rigs/.keep --
-- ctrl-city/city.toml --
[workspace]
name = "ctrl-city"

[daemon]
patrol_interval = "100ms"

[[agents]]
name = "mayor"
start_command = "echo hello"
