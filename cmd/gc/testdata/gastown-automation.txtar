# Gas Town automations — list, show, check, history.
#
# Tests automation CLI surface with Gas Town-style periodic formulas.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# Initialize city with automations
exec gc init --file $WORK/automation-city.toml $WORK/automationtown
cd $WORK/automationtown

# --- 1. Automation list shows available automations ---

exec gc automation list
stdout 'digest-generate'
stdout 'wisp-compact'

# --- 2. Automation show displays details ---

exec gc automation show digest-generate
stdout 'digest-generate'
stdout 'mol-digest-generate'
stdout 'cooldown'
stdout '24h'

exec gc automation show wisp-compact
stdout 'wisp-compact'
stdout 'mol-wisp-compact'

# --- 3. Automation show nonexistent ---

! exec gc automation show nonexistent
stderr 'not found'

# --- 4. Automation check reports readiness ---

exec gc automation check
# First run → all ready (no prior run)
stdout 'digest-generate'
stdout 'wisp-compact'

# --- 5. Automation history with no runs ---

exec gc automation history
stdout 'No automation history'

# --- 6. Error: missing subcommand ---

! exec gc automation
stderr 'missing subcommand'

# --- 7. Error: unknown subcommand ---

! exec gc automation blorp
stderr 'unknown subcommand "blorp"'

-- automation-city.toml --
[workspace]
name = "automationtown"

[formulas]
dir = "formulas"

[[agents]]
name = "deacon"
start_command = "echo hello"

-- automationtown/formulas/mol-digest-generate.formula.toml --
formula = "mol-digest-generate"
description = "Generate daily digest"

[[steps]]
id = "collect"
title = "Collect activity data"

[[steps]]
id = "generate"
title = "Generate digest"
needs = ["collect"]

-- automationtown/formulas/mol-wisp-compact.formula.toml --
formula = "mol-wisp-compact"
description = "Compact expired wisps"

[[steps]]
id = "scan"
title = "Scan for expired wisps"

-- automationtown/formulas/automations/digest-generate/automation.toml --
[automation]
description = "Generate daily code digest"
formula = "mol-digest-generate"
gate = "cooldown"
interval = "24h"
pool = "dog"

-- automationtown/formulas/automations/wisp-compact/automation.toml --
[automation]
description = "TTL-based wisp cleanup"
formula = "mol-wisp-compact"
gate = "cooldown"
interval = "1h"
