# Gas Town config integrity — validates the gastown example configuration
# through the CLI surface.
#
# Tests: city.toml parsing, topology expansion, agent listing,
# formula listing, config validation.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# --- 1. Gastown city.toml validates ---

exec gc init --file $WORK/gastown-city.toml $WORK/gastown
cd $WORK/gastown
exec gc config show --validate
stdout 'Config valid.'

# --- 2. Config show dumps workspace name ---

exec gc config show
stdout 'name = "gastown"'

# --- 3. Agent list shows city-scoped agents ---

exec gc agent list
stdout 'mayor'
stdout 'deacon'
stdout 'boot'
stdout 'dog'

# --- 4. Dog pool config is visible ---

exec gc agent list
stdout 'dog.*pool: min=0, max=3'

# --- 5. Without rigs, no rig-scoped agents ---

exec gc agent list
! stdout 'witness'
! stdout 'refinery'
! stdout 'polecat'

# --- 6. gc start launches city-scoped agents ---

exec gc start $WORK/gastown
stdout 'Started agent .mayor.'
stdout 'Started agent .deacon.'
stdout 'Started agent .boot.'
stdout 'City started.'

# --- 7. Formulas directory is configured ---

exec gc formula list
stdout 'mol-deacon-patrol'
stdout 'mol-witness-patrol'
stdout 'mol-refinery-patrol'
stdout 'mol-polecat-work'
stdout 'mol-shutdown-dance'
stdout 'mol-digest-generate'
stdout 'mol-wisp-compact'
stdout 'mol-prune-branches'

# --- 8. Formula show displays step info ---

exec gc formula show mol-polecat-work
stdout 'mol-polecat-work'
stdout 'load-context'
stdout 'branch-setup'

exec gc formula show mol-shutdown-dance
stdout 'mol-shutdown-dance'

# --- 9. Daemon config is preserved ---

exec gc config show
stdout 'patrol_interval = "30s"'
stdout 'max_restarts = 5'
stdout 'restart_window = "1h"'
stdout 'shutdown_timeout = "5s"'

# --- 10. gc stop cleans up ---

exec gc stop $WORK/gastown
stdout 'City stopped.'

# --- 11. Start with pool check for dog (echo 0 → min=0 → no dogs) ---

exec gc start $WORK/gastown-min
stdout 'City started.'
! stdout 'dog'

exec gc stop $WORK/gastown-min
stdout 'City stopped.'

# --- 12. Start with pool check for dog (echo 2 → 2 dogs) ---

exec gc start $WORK/gastown-dogs
stdout 'Started agent .dog-1.'
stdout 'Started agent .dog-2.'
stdout 'City started.'

exec gc stop $WORK/gastown-dogs

# --- Fixture files ---

-- gastown-city.toml --
[workspace]
name = "gastown"
provider = "claude"

[daemon]
patrol_interval = "30s"
max_restarts = 5
restart_window = "1h"
shutdown_timeout = "5s"

[formulas]
dir = "formulas"

[[agents]]
name = "mayor"
start_command = "echo hello"

[[agents]]
name = "deacon"
start_command = "echo hello"

[[agents]]
name = "boot"
start_command = "echo hello"

[[agents]]
name = "dog"
start_command = "echo hello"
[agents.pool]
min = 0
max = 3
check = "echo 0"

-- gastown-min/.gc/.keep --
-- gastown-min/rigs/.keep --
-- gastown-min/city.toml --
[workspace]
name = "gastown-min"

[daemon]
patrol_interval = "30s"

[[agents]]
name = "mayor"
start_command = "echo hello"

[[agents]]
name = "dog"
start_command = "echo hello"
[agents.pool]
min = 0
max = 3
check = "echo 0"

-- gastown-dogs/.gc/.keep --
-- gastown-dogs/rigs/.keep --
-- gastown-dogs/city.toml --
[workspace]
name = "gastown-dogs"

[daemon]
patrol_interval = "30s"

[[agents]]
name = "mayor"
start_command = "echo hello"

[[agents]]
name = "dog"
start_command = "echo hello"
[agents.pool]
min = 0
max = 3
check = "echo 2"

-- gastown/formulas/mol-deacon-patrol.formula.toml --
formula = "mol-deacon-patrol"
description = "Deacon patrol loop"

[[steps]]
id = "check-inbox"
title = "Check inbox"

[[steps]]
id = "check-gates"
title = "Evaluate gates"
needs = ["check-inbox"]

-- gastown/formulas/mol-witness-patrol.formula.toml --
formula = "mol-witness-patrol"
description = "Witness patrol loop"

[[steps]]
id = "check-inbox"
title = "Check inbox"

[[steps]]
id = "orphan-scan"
title = "Scan for orphaned beads"
needs = ["check-inbox"]

-- gastown/formulas/mol-refinery-patrol.formula.toml --
formula = "mol-refinery-patrol"
description = "Refinery merge processing"

[[steps]]
id = "check-inbox"
title = "Check inbox"

[[steps]]
id = "find-work"
title = "Find merge work"
needs = ["check-inbox"]

-- gastown/formulas/mol-polecat-work.formula.toml --
formula = "mol-polecat-work"
description = "Polecat implementation"

[variables]
issue = ""

[[steps]]
id = "load-context"
title = "Load work context"

[[steps]]
id = "branch-setup"
title = "Create or resume branch"
needs = ["load-context"]

[[steps]]
id = "implement"
title = "Implement changes"
needs = ["branch-setup"]

[[steps]]
id = "submit"
title = "Push and assign refinery"
needs = ["implement"]

-- gastown/formulas/mol-shutdown-dance.formula.toml --
formula = "mol-shutdown-dance"
description = "Shutdown dance with due process"

[variables]
warrant_id = ""
target = ""
reason = ""

[[steps]]
id = "check-1"
title = "First health check"

[[steps]]
id = "check-2"
title = "Second health check"
needs = ["check-1"]

[[steps]]
id = "verdict"
title = "Pardon or execute"
needs = ["check-2"]

-- gastown/formulas/mol-digest-generate.formula.toml --
formula = "mol-digest-generate"
description = "Generate activity digest"

[[steps]]
id = "collect"
title = "Collect activity"

[[steps]]
id = "generate"
title = "Generate digest"
needs = ["collect"]

-- gastown/formulas/mol-wisp-compact.formula.toml --
formula = "mol-wisp-compact"
description = "Compact closed wisps"

[[steps]]
id = "scan"
title = "Scan for expired wisps"

[[steps]]
id = "compact"
title = "Delete expired wisps"
needs = ["scan"]

-- gastown/formulas/mol-prune-branches.formula.toml --
formula = "mol-prune-branches"
description = "Prune merged branches"

[[steps]]
id = "prune"
title = "Delete merged gc/* branches"
