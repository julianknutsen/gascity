# Gas Town error paths â€” validate clear error messages across commands.
#
# Tests that user errors produce helpful messages without stack traces.
# Focuses on error paths not covered by other gastown-*.txtar files.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# --- Config errors ---

# Invalid TOML fails with parse error
cp $WORK/bad-toml $WORK/broken-city/city.toml
cd $WORK/broken-city
! exec gc config show
stderr 'gc config show'

# Duplicate agents fail validation
cp $WORK/dup-agents $WORK/dup-city/city.toml
cd $WORK/dup-city
! exec gc config show --validate
stderr 'duplicate'

# --- Commands outside city ---

cd $WORK
! exec gc config show
stderr 'not in a city directory'

! exec gc agent list
stderr 'not in a city directory'

! exec gc events
stderr 'not in a city directory'

! exec gc convoy list
stderr 'not in a city directory'

! exec gc formula list
stderr 'not in a city directory'

# --- Bad bead operations ---

exec gc init $WORK/err-city
cd $WORK/err-city

# Close nonexistent bead
! exec bd close gc-999
stderr 'not found'

# Show nonexistent bead
! exec bd show gc-999
stderr 'not found'

# Create with no title
! exec bd create
stderr 'missing title'

# --- Agent errors ---

# Attach nonexistent agent
! exec gc agent attach nonexistent
stderr 'not found'

# Status nonexistent agent
! exec gc agent status nonexistent
stderr 'not found'

# Nudge nonexistent agent (requires name + message)
! exec gc agent nudge nonexistent 'hello'
stderr 'not found'

# Drain nonexistent agent
! exec gc agent drain nonexistent
stderr 'not found'

# Kill nonexistent agent
! exec gc agent kill nonexistent
stderr 'not found'

# Missing agent name for various subcommands
! exec gc agent drain
stderr 'missing agent name'

! exec gc agent undrain
stderr 'missing agent name'

! exec gc agent attach
stderr 'missing agent name'

! exec gc agent nudge
stderr 'usage:'

! exec gc agent kill
stderr 'missing agent name'

! exec gc agent status
stderr 'missing agent name'

# --- Mail errors ---

! exec gc mail send
stderr 'usage:'

! exec gc mail send nobody 'hello'
stderr 'unknown recipient'

! exec gc mail read
stderr 'missing message ID'

! exec gc mail read gc-999
stderr 'not found'

! exec gc mail archive
stderr 'missing message ID'

! exec gc mail archive gc-999
stderr 'not found'

# --- Formula errors ---

! exec gc formula show nonexistent
stderr 'not found'

# --- Event errors ---

! exec gc event emit
# event emit with no type fails

! exec gc events --since notaduration
stderr 'invalid --since'

! exec gc events --watch --timeout=notaduration
stderr 'invalid --timeout'

# --- Sling errors ---

! exec gc sling
# Missing required args fails

# --- Handoff errors ---

! exec gc handoff
# Missing args fails

# --- Isolation value validation ---

cp $WORK/bad-isolation $WORK/iso-city/city.toml
cd $WORK/iso-city
! exec gc config show --validate
stderr 'isolation'

-- broken-city/.gc/.keep --
-- bad-toml --
{{invalid toml syntax
-- dup-city/.gc/.keep --
-- dup-agents --
[workspace]
name = "dup-city"

[[agents]]
name = "worker"

[[agents]]
name = "worker"
-- bad-isolation --
[workspace]
name = "iso-city"

[[agents]]
name = "worker"
isolation = "invalid-value"
-- iso-city/.gc/.keep --
