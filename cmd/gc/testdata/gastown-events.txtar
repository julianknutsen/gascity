# Gas Town events â€” verify event recording across all command types.
#
# Tests that bead, mail, convoy, and custom operations emit events
# and that event filtering works correctly.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# Initialize city
exec gc init $WORK/bright-lights
cd $WORK/bright-lights

# --- 1. Bead operations emit events ---

exec bd create 'Fix authentication'
exec bd close gc-1
exec gc events --type bead.created
stdout 'gc-1'
exec gc events --type bead.closed
stdout 'gc-1'

# --- 2. Mail operations emit events ---

exec gc mail send mayor 'Deploy status?'
exec gc mail read gc-2

exec gc events --type mail.sent
stdout 'gc-2'
exec gc events --type mail.read
stdout 'gc-2'

# --- 3. Convoy operations emit events ---

exec bd create 'Task A'
exec gc convoy create 'Sprint' gc-3
exec gc events --type convoy.created
stdout 'gc-4'

exec gc convoy close gc-4
exec gc events --type convoy.closed
stdout 'gc-4'

# --- 4. Custom events via gc event emit ---

exec gc event emit agent.crashed --subject mayor --actor controller --message 'Session timeout'
exec gc events --type agent.crashed
stdout 'agent.crashed'
stdout 'mayor'

# --- 5. Event ordering is monotonic ---

exec gc event emit test.first --message 'one'
exec gc event emit test.second --message 'two'
exec gc event emit test.third --message 'three'

exec gc events
stdout 'test.first'
stdout 'test.second'
stdout 'test.third'

# --- 6. Filter by --since (events within last hour) ---

exec gc events --since 1h
stdout 'bead.created'
stdout 'mail.sent'

# --- 7. No events for unknown type ---

exec gc events --type does.not.exist
stdout 'No events.'

# --- 8. Watch mode with short timeout exits cleanly ---

exec gc events --watch --type=nonexistent.event --timeout=100ms
! stdout '.'

# --- 9. --payload-match filtering (standard mode) ---

exec gc event emit deploy.started --payload '{"version":"2.1","env":"staging"}'
exec gc event emit deploy.finished --payload '{"version":"3.0","env":"prod"}'

# Filter by payload key=value in standard (non-watch) mode.
exec gc events --type deploy.finished --payload-match version=3.0
stdout 'deploy.finished'
! stdout 'deploy.started'

# Filter by different payload key.
exec gc events --payload-match env=staging
stdout 'deploy.started'
! stdout 'deploy.finished'

-- bright-lights/city.toml --
[workspace]
name = "bright-lights"

[[agents]]
name = "mayor"
start_command = "echo hello"
