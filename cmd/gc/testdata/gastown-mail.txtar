# Gas Town mail — agent-to-agent messaging patterns.
#
# Builds on mail.txtar: tests multi-agent mail routing,
# gc mail check exit codes, qualified agent names.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# Initialize city with multiple agents
exec gc init --file $WORK/mail-city.toml $WORK/mailtown
cd $WORK/mailtown

# --- 1. Mayor sends mail to deacon ---

exec gc mail send deacon 'Start patrol loop'
stdout 'Sent message gc-1 to deacon'

# --- 2. Deacon checks inbox ---

exec gc mail inbox deacon
stdout 'human'
stdout 'Start patrol loop'

# --- 3. gc mail check exit codes ---

# Deacon has mail → exit 0
exec gc mail check deacon

# Worker has no mail → exit 1
! exec gc mail check worker

# --- 4. Agent-to-agent mail (deacon → mayor) ---

env GC_AGENT=deacon
exec gc mail send mayor 'Patrol complete, 3 issues found'
stdout 'Sent message gc-2 to mayor'

# --- 5. Mayor reads deacon's message ---

env GC_AGENT=
exec gc mail inbox mayor
stdout 'deacon'
stdout 'Patrol complete'

exec gc mail read gc-2
stdout 'From:   deacon'
stdout 'To:     mayor'

# --- 6. Multi-agent mail chain ---

# Mayor sends work to witness
exec gc mail send witness 'Check rig health'
stdout 'Sent message gc-3 to witness'

# Witness reads and replies
env GC_AGENT=witness
exec gc mail read gc-3
stdout 'From:   human'
stdout 'Body:   Check rig health'

exec gc mail send mayor 'Rig healthy, 2 polecats active'
stdout 'Sent message gc-4 to mayor'

# --- 7. Mail archive removes from inbox ---

env GC_AGENT=
exec gc mail inbox mayor
stdout 'gc-4'

exec gc mail archive gc-4
stdout 'Archived message gc-4'

exec gc mail inbox mayor
! stdout 'gc-4'

# --- 8. Archived message still readable ---

exec gc mail read gc-2
stdout 'From:   deacon'

# --- 9. Multiple messages to same agent ---

exec gc mail send worker 'Task one'
exec gc mail send worker 'Task two'
exec gc mail send worker 'Task three'

exec gc mail inbox worker
stdout 'Task one'
stdout 'Task two'
stdout 'Task three'

-- mail-city.toml --
[workspace]
name = "mailtown"

[[agents]]
name = "mayor"
start_command = "echo hello"

[[agents]]
name = "deacon"
start_command = "echo hello"

[[agents]]
name = "witness"
start_command = "echo hello"

[[agents]]
name = "worker"
start_command = "echo hello"
