# Gas Town sling dispatch â€” route work to agents and pools.
#
# Tests gc sling CLI surface: target resolution, error paths,
# warning messages for suspended/empty pools.
# Actual bd update routing is tested in unit tests (cmd_sling_test.go).

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# Initialize city with agents
exec gc init --file $WORK/sling-city.toml $WORK/sling
cd $WORK/sling

# --- 1. Sling missing args ---

! exec gc sling
stderr 'requires 2 arguments'

# --- 2. Sling to nonexistent target ---

exec bd create 'Test work'
! exec gc sling nonexistent gc-1
stderr 'not found in config'

# --- 3. Sling to suspended agent warns ---

exec gc agent suspend worker
! exec gc sling worker gc-1
stderr 'warning.*suspended'

exec gc agent resume worker

# --- 4. Sling to empty pool warns ---

! exec gc sling empty-pool gc-1
stderr 'warning.*max=0'

# --- 5. Sling with --formula but no bd mol cook ---

! exec gc sling mayor fake-formula --formula
stderr 'instantiating formula'

-- sling-city.toml --
[workspace]
name = "sling"

[[agents]]
name = "mayor"
start_command = "echo hello"
sling_query = "bd update {} --assignee=mayor"

[[agents]]
name = "worker"
start_command = "echo hello"
sling_query = "bd update {} --assignee=worker"

[[agents]]
name = "empty-pool"
start_command = "echo hello"
sling_query = "bd update {} --label=pool:empty-pool"
[agents.pool]
min = 0
max = 0
check = "echo 0"
