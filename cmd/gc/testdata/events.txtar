# Events — verify event recording and gc events command
#
# Tests that bead create/close and mail send/read emit events,
# and that gc events displays them with filtering.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# Initialize city
exec gc init $WORK/bright-lights
cd $WORK/bright-lights

# --- Create a bead → should emit bead.created ---

exec bd create 'Build Tower of Hanoi'
stdout 'Created bead: gc-1'

# --- Close a bead → should emit bead.closed ---

exec bd close gc-1
stdout 'Closed bead: gc-1'

# --- Send mail → should emit mail.sent ---

exec gc mail send mayor 'hey there'
stdout 'Sent message gc-2 to mayor'

# --- Read mail → should emit mail.read ---

exec gc mail read gc-2
stdout 'Body:   hey there'

# --- View all events ---

exec gc events
stdout 'bead.created'
stdout 'bead.closed'
stdout 'mail.sent'
stdout 'mail.read'
stdout 'gc-1'

# --- Filter by type ---

exec gc events --type bead.created
stdout 'bead.created'
! stdout 'bead.closed'
! stdout 'mail.sent'

# --- No events for unknown type ---

exec gc events --type agent.crashed
stdout 'No events.'

# --- gc event emit (external event recording) ---

exec gc event emit bead.updated --subject gc-1 --message 'Updated title'
exec gc events --type bead.updated
stdout 'bead.updated'
stdout 'gc-1'

# --- gc event emit with --actor ---

exec gc event emit agent.started --subject mayor --actor gc --message 'started session'
exec gc events --type agent.started
stdout 'agent.started'
stdout 'gc'

# --- gc event emit (missing type arg → exit 1) ---

! exec gc event emit

# --- gc event (missing subcommand) ---

! exec gc event
stderr 'missing subcommand'

# --- Invalid --since ---

! exec gc events --since notaduration
stderr 'invalid --since'
