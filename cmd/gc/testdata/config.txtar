# gc config â€” inspect and validate city configuration.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# Config outside a city fails.
! exec gc config show
stderr 'not in a city directory'

# Initialize a healthy city.
exec gc init $WORK/my-city
cd $WORK/my-city

# Config show dumps the resolved config as TOML.
exec gc config show
stdout 'name = "my-city"'
stdout '\[workspace\]'

# Config show --validate on a healthy city passes.
exec gc config show --validate
stdout 'Config valid.'

# Add an agent and verify it appears in output.
cp $WORK/city-with-agent $WORK/my-city/city.toml
exec gc config show
stdout 'name = "mayor"'
stdout '\[\[agents\]\]'

# Validate passes with valid agent config.
exec gc config show --validate
stdout 'Config valid.'

# Broken config fails to parse.
cp $WORK/bad-toml $WORK/broken-city/city.toml
cd $WORK/broken-city
! exec gc config show
stderr 'gc config show'

# Broken config also fails --validate.
! exec gc config show --validate
stderr 'gc config show'

# Invalid config (duplicate agents) fails --validate.
cp $WORK/dup-agents $WORK/my-city/city.toml
cd $WORK/my-city
! exec gc config show --validate
stderr 'duplicate name'

# Show mode prints validation warnings to stderr but still outputs config.
exec gc config show
stderr 'warning.*duplicate'
stdout '\[\[agents\]\]'

-- broken-city/.gc/.keep --
-- bad-toml --
{{invalid toml
-- city-with-agent --
[workspace]
name = "my-city"

[[agents]]
name = "mayor"
-- dup-agents --
[workspace]
name = "my-city"

[[agents]]
name = "mayor"

[[agents]]
name = "mayor"
