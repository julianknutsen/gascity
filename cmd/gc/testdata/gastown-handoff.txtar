# Gas Town handoff â€” self and remote handoff tests.
#
# Tests gc handoff CLI surface. Self-handoff blocks forever
# (so we test error paths). Remote handoff is non-blocking.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# Initialize city
exec gc init --file $WORK/handoff-city.toml $WORK/handofftown
cd $WORK/handofftown

# --- 1. Self-handoff requires agent context ---

! exec gc handoff 'Context refresh'
stderr 'not in agent context'

# --- 2. Remote handoff to existing agent (session not running) ---

exec gc handoff --target mayor 'Context refresh' 'Please review inbox for latest status'
stdout 'Handoff.*sent mail.*to mayor'
stdout 'session not running'

# --- 3. Remote handoff creates mail ---

exec gc mail inbox mayor
stdout 'Context refresh'

# --- 4. Remote handoff to nonexistent agent ---

! exec gc handoff --target nonexistent 'hello'
stderr 'not found'

# --- 5. Handoff requires at least one arg ---

! exec gc handoff
# Missing args

# --- 6. Remote handoff from agent context ---

env GC_AGENT=deacon
exec gc handoff --target mayor 'Patrol complete'
stdout 'Handoff.*sent mail.*to mayor'

# Verify deacon's mail is in mayor's inbox
env GC_AGENT=
exec gc mail inbox mayor
stdout 'Patrol complete'

-- handoff-city.toml --
[workspace]
name = "handofftown"

[[agents]]
name = "mayor"
start_command = "echo hello"

[[agents]]
name = "deacon"
start_command = "echo hello"
