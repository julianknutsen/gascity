# Attached Molecules â€” formula-on-bead lifecycle
#
# Validates gc mol create --on, gc mol status/step done resolving
# through a base bead's attached_molecule field.

env GC_BEADS=file
env GC_DOLT=skip
env GC_SESSION=fake

# Initialize city
exec gc init $WORK/bright-lights
cd $WORK/bright-lights

# Copy cooking formula into the formulas directory
mkdir $WORK/bright-lights/.gc/formulas
cp $WORK/cooking.formula.toml $WORK/bright-lights/.gc/formulas/cooking.formula.toml

# --- Create base bead with recipe context ---

exec gc bd create 'Pancakes: dry=flour,sugar,salt. wet=eggs,milk,butter. temp=375F'
stdout 'gc-1'

# --- Attach molecule to bead ---

exec gc mol create cooking --on gc-1
stdout 'Created molecule gc-2'
stdout '5 steps'
stdout 'attached to gc-1'

# --- Status via base bead ---

exec gc mol status gc-1
stdout 'BEAD'
stdout 'Context:'
stdout 'dry=flour'
stdout 'MOLECULE  gc-2'
stdout '0/5 complete'
stdout 'gc mol step done gc-1 dry'

# --- Walk all steps via base bead ---

exec gc mol step done gc-1 dry
stdout 'Step 1/5'
stdout 'Current step: wet'
stdout 'gc mol step done gc-1 wet'

exec gc mol step done gc-1 wet
stdout 'Step 2/5'
stdout 'Current step: combine'

exec gc mol step done gc-1 combine
stdout 'Step 3/5'
stdout 'Current step: cook'

exec gc mol step done gc-1 cook
stdout 'Step 4/5'
stdout 'Current step: serve'

exec gc mol step done gc-1 serve
stdout 'Step 5/5'
stdout 'All steps complete'

# --- Verify molecule closed, base bead still open ---

exec gc bd show gc-2
stdout 'closed'

exec gc bd show gc-1
stdout 'open'

# --- Status via molecule ID still works ---

exec gc mol status gc-2
stdout 'MOLECULE  gc-2'
stdout 'All steps complete'

# --- Error: base bead with no attachment ---

exec gc bd create 'Just a task'
! exec gc mol status gc-8
stderr 'not a molecule and has no attached molecule'

-- cooking.formula.toml --
formula = "cooking"
description = "Generic cooking workflow"

[[steps]]
id = "dry"
title = "Gather dry ingredients"
description = "Measure and combine all dry ingredients from the recipe."

[[steps]]
id = "wet"
title = "Gather wet ingredients"
description = "Measure and combine all wet ingredients from the recipe."

[[steps]]
id = "combine"
title = "Combine wet and dry"
description = "Fold wet into dry according to recipe instructions."
needs = ["dry", "wet"]

[[steps]]
id = "cook"
title = "Cook"
description = "Cook according to the recipe's method and temperature."
needs = ["combine"]

[[steps]]
id = "serve"
title = "Serve"
description = "Plate and garnish according to the recipe."
needs = ["cook"]
