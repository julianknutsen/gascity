#!/usr/bin/env bash
# test-docker-session â€” integration tests for gc-session-docker
#
# Usage: ./scripts/test-docker-session
#
# Exercises the exec provider protocol against the Docker session script.
# Requires: docker, jq
#
# Builds a minimal test image inline with readiness detection support.

set -euo pipefail

SCRIPT="$(cd "$(dirname "$0")" && pwd)/gc-session-docker"
SESSION="gc-docker-test"
TEST_IMAGE="gc-test-agent"

pass=0
fail=0

check() {
    local desc="$1" expected="$2" got="$3"
    if [ "$got" = "$expected" ]; then
        echo "  PASS: $desc"
        ((pass++)) || true
    else
        echo "  FAIL: $desc (expected '$expected', got '$got')"
        ((fail++)) || true
    fi
}

check_contains() {
    local desc="$1" needle="$2" haystack="$3"
    if echo "$haystack" | grep -qF "$needle"; then
        echo "  PASS: $desc"
        ((pass++)) || true
    else
        echo "  FAIL: $desc (expected to contain '$needle', got '$haystack')"
        ((fail++)) || true
    fi
}

BUILD_CTX=""

cleanup() {
    echo ""
    echo "--- Cleanup ---"
    "$SCRIPT" stop "$SESSION" 2>/dev/null || true
    "$SCRIPT" stop "${SESSION}-ready" 2>/dev/null || true
    "$SCRIPT" stop "${SESSION}-delay" 2>/dev/null || true
    "$SCRIPT" stop "${SESSION}-nohints" 2>/dev/null || true
    "$SCRIPT" stop "${SESSION}-proc" 2>/dev/null || true
    "$SCRIPT" stop "${SESSION}-setup" 2>/dev/null || true
    "$SCRIPT" stop "${SESSION}-dead" 2>/dev/null || true
    [ -n "$BUILD_CTX" ] && rm -rf "$BUILD_CTX"
}
trap cleanup EXIT

echo "=== gc-session-docker integration tests ==="
echo "Script: $SCRIPT"
echo ""

# --- Build test image ---
echo "--- Building test image ---"
BUILD_CTX=$(mktemp -d)

cat > "$BUILD_CTX/entrypoint.sh" <<'ENTRY'
#!/bin/sh
echo "Initializing..."
sleep 1
echo "> "
exec sleep 300
ENTRY
chmod +x "$BUILD_CTX/entrypoint.sh"

cat > "$BUILD_CTX/Dockerfile" <<'DOCKERFILE'
FROM alpine:latest
RUN apk add --no-cache procps
COPY entrypoint.sh /entrypoint.sh
CMD ["/entrypoint.sh"]
DOCKERFILE

docker build -t "$TEST_IMAGE" "$BUILD_CTX"
echo "  OK: built $TEST_IMAGE"
echo ""

# =====================================================================
# Test: pre-pull check (missing image)
# =====================================================================
echo "--- pre-pull check (missing image) ---"
config=$(cat <<EOF
{
    "command": "echo hi",
    "work_dir": "/tmp",
    "env": { "GC_DOCKER_IMAGE": "gc-nonexistent-image-42:latest" }
}
EOF
)
rc=0
echo "$config" | "$SCRIPT" start "${SESSION}-prepull" 2>/dev/null || rc=$?
check "pre-pull fails on missing image" "1" "$rc"
# Clean up in case it somehow started.
"$SCRIPT" stop "${SESSION}-prepull" 2>/dev/null || true

# =====================================================================
# Test: start with ready_prompt_prefix
# =====================================================================
echo "--- start with ready_prompt_prefix ---"
config=$(cat <<EOF
{
    "command": "/entrypoint.sh",
    "work_dir": "/tmp",
    "ready_prompt_prefix": "> ",
    "env": {
        "GC_DOCKER_IMAGE": "$TEST_IMAGE",
        "GC_DOCKER_HOME_MOUNT": "false"
    }
}
EOF
)
echo "$config" | "$SCRIPT" start "${SESSION}-ready"
echo "  PASS: start with prompt prefix (no error)"
((pass++)) || true

# Verify container is running.
running=$("$SCRIPT" is-running "${SESSION}-ready")
check "prompt-detected container is running" "true" "$running"
"$SCRIPT" stop "${SESSION}-ready" 2>/dev/null || true

# =====================================================================
# Test: start with process_names
# =====================================================================
echo "--- start with process_names ---"
config=$(cat <<EOF
{
    "command": "/entrypoint.sh",
    "work_dir": "/tmp",
    "process_names": ["sleep"],
    "env": {
        "GC_DOCKER_IMAGE": "$TEST_IMAGE",
        "GC_DOCKER_HOME_MOUNT": "false"
    }
}
EOF
)
echo "$config" | "$SCRIPT" start "${SESSION}-proc"
echo "  PASS: start with process_names (no error)"
((pass++)) || true

running=$("$SCRIPT" is-running "${SESSION}-proc")
check "process-detected container is running" "true" "$running"
"$SCRIPT" stop "${SESSION}-proc" 2>/dev/null || true

# =====================================================================
# Test: start with ready_delay_ms
# =====================================================================
echo "--- start with ready_delay_ms ---"
config=$(cat <<EOF
{
    "command": "echo 'delayed start' && sleep 300",
    "work_dir": "/tmp",
    "ready_delay_ms": 1000,
    "env": {
        "GC_DOCKER_IMAGE": "$TEST_IMAGE",
        "GC_DOCKER_HOME_MOUNT": "false"
    }
}
EOF
)
start_time=$SECONDS
echo "$config" | "$SCRIPT" start "${SESSION}-delay"
elapsed=$((SECONDS - start_time))
# Should have waited at least 1 second.
if [ "$elapsed" -ge 1 ]; then
    echo "  PASS: ready_delay_ms waited ~${elapsed}s"
    ((pass++)) || true
else
    echo "  FAIL: ready_delay_ms waited only ${elapsed}s (expected >= 1)"
    ((fail++)) || true
fi
"$SCRIPT" stop "${SESSION}-delay" 2>/dev/null || true

# =====================================================================
# Test: start with no hints (fire-and-forget)
# =====================================================================
echo "--- start with no hints ---"
config=$(cat <<EOF
{
    "command": "sleep 300",
    "work_dir": "/tmp",
    "env": {
        "GC_DOCKER_IMAGE": "$TEST_IMAGE",
        "GC_DOCKER_HOME_MOUNT": "false"
    }
}
EOF
)
echo "$config" | "$SCRIPT" start "${SESSION}-nohints"
echo "  PASS: start with no hints (no error)"
((pass++)) || true

running=$("$SCRIPT" is-running "${SESSION}-nohints")
check "no-hints container is running" "true" "$running"
"$SCRIPT" stop "${SESSION}-nohints" 2>/dev/null || true

# =====================================================================
# Test: container labels
# =====================================================================
echo "--- container labels ---"
config=$(cat <<EOF
{
    "command": "/entrypoint.sh",
    "work_dir": "/tmp",
    "ready_prompt_prefix": "> ",
    "env": {
        "GC_DOCKER_IMAGE": "$TEST_IMAGE",
        "GC_DOCKER_HOME_MOUNT": "false"
    }
}
EOF
)
echo "$config" | "$SCRIPT" start "$SESSION"
label_managed=$(docker inspect -f '{{index .Config.Labels "gc.managed"}}' "$SESSION" 2>/dev/null || echo "MISSING")
label_agent=$(docker inspect -f '{{index .Config.Labels "gc.agent"}}' "$SESSION" 2>/dev/null || echo "MISSING")
check "gc.managed label" "true" "$label_managed"
check "gc.agent label" "$SESSION" "$label_agent"

# =====================================================================
# Test: is-running (uses container from above)
# =====================================================================
echo "--- is-running ---"
running=$("$SCRIPT" is-running "$SESSION")
check "container is running" "true" "$running"

# =====================================================================
# Test: peek
# =====================================================================
echo "--- peek ---"
output=$("$SCRIPT" peek "$SESSION" 5)
check_contains "peek shows output" "Initializing" "$output"

# =====================================================================
# Test: process-alive with specific process name
# =====================================================================
echo "--- process-alive ---"
alive=$(echo "sleep" | "$SCRIPT" process-alive "$SESSION")
check "process-alive (sleep)" "true" "$alive"

alive=$(echo "nonexistent-process-xyz" | "$SCRIPT" process-alive "$SESSION")
check "process-alive (nonexistent)" "false" "$alive"

# =====================================================================
# Test: set-meta / get-meta
# =====================================================================
echo "--- set-meta / get-meta ---"
echo -n "test-value-42" | "$SCRIPT" set-meta "$SESSION" "my-key"
got=$("$SCRIPT" get-meta "$SESSION" "my-key")
check "meta round-trip" "test-value-42" "$got"

# =====================================================================
# Test: get-meta (missing key)
# =====================================================================
echo "--- get-meta (missing key) ---"
got=$("$SCRIPT" get-meta "$SESSION" "no-such-key")
check "missing meta is empty" "" "$got"

# =====================================================================
# Test: remove-meta
# =====================================================================
echo "--- remove-meta ---"
"$SCRIPT" remove-meta "$SESSION" "my-key"
got=$("$SCRIPT" get-meta "$SESSION" "my-key")
check "removed meta is empty" "" "$got"

# =====================================================================
# Test: nudge (no-op)
# =====================================================================
echo "--- nudge (no-op) ---"
echo -n "wake up" | "$SCRIPT" nudge "$SESSION"
echo "  PASS: nudge (no error, clean no-op)"
((pass++)) || true

# =====================================================================
# Test: list-running
# =====================================================================
echo "--- list-running ---"
listed=$("$SCRIPT" list-running "gc-docker-test")
check_contains "list-running finds session" "$SESSION" "$listed"

# =====================================================================
# Test: session setup command executes on host
# =====================================================================
echo "--- session setup ---"
setup_marker="/tmp/gc-docker-test-setup-marker-$$"
rm -f "$setup_marker"
config=$(cat <<EOF
{
    "command": "sleep 300",
    "work_dir": "/tmp",
    "session_setup": ["touch $setup_marker"],
    "env": {
        "GC_DOCKER_IMAGE": "$TEST_IMAGE",
        "GC_DOCKER_HOME_MOUNT": "false"
    }
}
EOF
)
"$SCRIPT" stop "${SESSION}-setup" 2>/dev/null || true
echo "$config" | "$SCRIPT" start "${SESSION}-setup"
if [ -f "$setup_marker" ]; then
    echo "  PASS: session setup created marker file on host"
    ((pass++)) || true
else
    echo "  FAIL: session setup marker not found"
    ((fail++)) || true
fi
rm -f "$setup_marker"
"$SCRIPT" stop "${SESSION}-setup" 2>/dev/null || true

# =====================================================================
# Test: interrupt
# =====================================================================
echo "--- interrupt ---"
"$SCRIPT" interrupt "$SESSION"
sleep 0.5
echo "  PASS: interrupt (no error)"
((pass++)) || true

# =====================================================================
# Test: unknown operation (forward compat)
# =====================================================================
echo "--- unknown operation ---"
rc=0
"$SCRIPT" future-op "$SESSION" 2>/dev/null || rc=$?
check "unknown op exits 2" "2" "$rc"

# =====================================================================
# Test: stop
# =====================================================================
echo "--- stop ---"
"$SCRIPT" stop "$SESSION"
sleep 0.5
running=$("$SCRIPT" is-running "$SESSION")
check "stopped container is not running" "false" "$running"

# =====================================================================
# Test: stop idempotent
# =====================================================================
echo "--- stop (idempotent) ---"
"$SCRIPT" stop "$SESSION"
echo "  PASS: double stop (no error)"
((pass++)) || true

echo ""
echo "=== Results: $pass passed, $fail failed ==="
[ "$fail" -eq 0 ]
