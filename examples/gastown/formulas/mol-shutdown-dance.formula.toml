description = """
Shutdown dance — due process for stuck agents.

Dispatched by filing a warrant bead with `--label=role:dog`:

```bash
bd create --type=warrant \
  --title="Stuck: <agent>" \
  --metadata '{"target":"<session>","reason":"<reason>","requester":"<who>"}' \
  --label=role:dog
```

The dog pool picks up the warrant and pours this formula. Each wisp is
one shutdown dance for one target. On crash, `bd mol current` resumes
from the last completed step.

## State Machine

```
RECEIVE → INTERROGATE (1) → INTERROGATE (2) → INTERROGATE (3) → EXECUTE → EPITAPH
              ↓                   ↓                   ↓
           ALIVE?             ALIVE?              ALIVE?
              ↓                   ↓                   ↓
           [yes → EPITAPH with PARDONED]          [no → EXECUTE]
```

## Timeouts

| Attempt | Timeout | Cumulative |
|---------|---------|------------|
| 1       | 60s     | 60s        |
| 2       | 120s    | 180s (3m)  |
| 3       | 240s    | 420s (7m)  |

## Who files warrants

| Detector | Stuck agent | Detection method |
|----------|-------------|-----------------|
| Deacon health-scan | Witness | Stale patrol wisp |
| Deacon health-scan | Refinery | Stale wisp + queue has work |
| Deacon utility-agent-health | Dog | Stale wisp/bead |
| Witness check-polecat-health | Polecat | Stale work bead, no progress |

No agent kills anything directly. The shutdown dance is the single
recovery mechanism for all stuck agents.

Read each step's description before acting — Config values override defaults."""
formula = "mol-shutdown-dance"
version = 1

[vars]
[vars.warrant_id]
description = "Bead ID of the warrant being processed (from metadata on the wisp)"
required = true

[vars.target]
description = "Session name of the agent to interrogate"
required = true

[vars.reason]
description = "Why the warrant was filed"
required = true

[vars.requester]
description = "Who filed the warrant (deacon, witness, etc.)"
required = true
default = "deacon"

[[steps]]
id = "receive-warrant"
title = "Validate warrant and confirm target alive"
description = """
Entry point. Read the warrant metadata from your wisp.

**1. Read warrant details:**
```bash
bd show <wisp-id> --json | jq '.metadata'
```
Extract: `target`, `reason`, `requester`, `warrant_id`.

**2. Verify the warrant bead exists and is open:**
```bash
bd show {{warrant_id}} --json | jq '.status'
```
If warrant is already closed (another dog handled it, or requester
cancelled): close this step, burn the wisp, exit.

**3. Check if target session is alive:**
```bash
gc peek {{target}} 1
```
If target session doesn't exist (already dead):
- Close warrant: `bd close {{warrant_id}} --reason "Target already dead"`
- Send DOG_DONE mail to requester
- Burn this wisp, exit

**4. If target is alive:** close this step and proceed to interrogation."""

[[steps]]
id = "interrogate-1"
title = "First health check (60s timeout)"
needs = ["receive-warrant"]
description = """
First attempt to contact the stuck agent. Give it 60 seconds.

**1. Send health check via nudge:**
```bash
gc nudge {{target}} "[DOG] HEALTH CHECK: Respond ALIVE within 60s or face termination.
Warrant: {{warrant_id}}
Reason: {{reason}}
Filed by: {{requester}}
Attempt: 1/3"
```

**2. Wait 60 seconds:**
```bash
sleep 60
```

**3. Check for response:**
```bash
gc peek {{target}} 50
```

Look for the ALIVE keyword in the output after your health check message.
Also check for any sign of active work (new tool calls, output being
generated). Use judgment — explicit "ALIVE" is definitive, but active
output also indicates the agent is functioning.

**4. If ALIVE or active:**
- Close warrant: `bd close {{warrant_id}} --reason "Session responded at attempt 1"`
- Send mail: `gc mail send {{requester}}/ -s "PARDON: {{target}}" -m "Responded after attempt 1"`
- Burn wisp, exit

**5. If no response:** close this step, proceed to interrogation-2."""

[[steps]]
id = "interrogate-2"
title = "Second health check (120s timeout)"
needs = ["interrogate-1"]
description = """
Second attempt with longer timeout. Only reached if first attempt
got no response.

**1. Send health check:**
```bash
gc nudge {{target}} "[DOG] HEALTH CHECK: Respond ALIVE within 120s or face termination.
Warrant: {{warrant_id}}
Reason: {{reason}}
Filed by: {{requester}}
Attempt: 2/3"
```

**2. Wait 120 seconds:**
```bash
sleep 120
```

**3. Check for response:**
```bash
gc peek {{target}} 50
```

Same evaluation as attempt 1: ALIVE keyword or active output.

**4. If ALIVE or active:**
- Close warrant: `bd close {{warrant_id}} --reason "Session responded at attempt 2"`
- Send mail: `gc mail send {{requester}}/ -s "PARDON: {{target}}" -m "Responded after attempt 2"`
- Burn wisp, exit

**5. If no response:** close this step, proceed to final interrogation."""

[[steps]]
id = "interrogate-3"
title = "Final health check (240s timeout)"
needs = ["interrogate-2"]
description = """
Final attempt before execution. 240 seconds — if the agent can't
respond in 4 minutes after 3 attempts, it's genuinely stuck.

**1. Send health check:**
```bash
gc nudge {{target}} "[DOG] HEALTH CHECK: FINAL WARNING. Respond ALIVE within 240s.
Warrant: {{warrant_id}}
Reason: {{reason}}
Filed by: {{requester}}
Attempt: 3/3 — session will be terminated if no response"
```

**2. Wait 240 seconds:**
```bash
sleep 240
```

**3. Check for response:**
```bash
gc peek {{target}} 50
```

**4. If ALIVE or active:**
- Close warrant: `bd close {{warrant_id}} --reason "Session responded at attempt 3"`
- Send mail: `gc mail send {{requester}}/ -s "PARDON: {{target}}" -m "Responded after attempt 3 (close call)"`
- Burn wisp, exit

**5. If no response:** close this step, proceed to execute."""

[[steps]]
id = "execute"
title = "Execute warrant — kill session"
needs = ["interrogate-3"]
description = """
Three attempts, no response. Execute the warrant.

**1. Capture final pane output for forensics:**
```bash
gc peek {{target}} 100
```
Save this output — it's the last evidence of what the agent was doing.

**2. Kill the session:**
```bash
gc agent request-restart {{target}}
```
This sets restart-requested metadata. If the agent is truly stuck
(not responding to nudges), the controller will kill and restart it
on the next reconcile tick.

If `request-restart` doesn't work (agent can't process it because
it's fully stuck), escalate:
```bash
gc mail send {{requester}}/ -s "EXECUTE_FAILED: {{target}}" \
  -m "request-restart didn't take effect. Agent may need manual kill."
```

**3. Record execution on the warrant:**
```bash
bd close {{warrant_id}} --reason "Executed after 3 failed attempts (420s total)"
```

Close this step, proceed to epitaph."""

[[steps]]
id = "epitaph"
title = "Log outcome, notify, and exit"
needs = ["execute"]
description = """
Final step. Create audit record and exit.

**1. Send DOG_DONE notification to requester:**
```bash
gc mail send {{requester}}/ -s "DOG_DONE: {{target}} warrant executed" \
  -m "Warrant: {{warrant_id}}
Target: {{target}}
Reason: {{reason}}
Outcome: EXECUTED after 3 attempts (60s + 120s + 240s = 420s)
Action: request-restart sent to controller"
```

**2. Close work bead (if separate from warrant):**
If your assigned work bead is different from the warrant bead, close it:
```bash
bd close <work-bead> --reason "Shutdown dance complete: {{target}} executed"
```

**3. Exit:**
```bash
exit
```

The controller sees you as idle and can assign new work or recycle
your pool slot.

**Note:** The pardon path (ALIVE detected) exits early from the
interrogation steps and never reaches this step. This step only
handles the execution path."""
