description = """
TTL-based cleanup of expired ephemeral beads (wisps).

This is a **automation formula** — dispatched by the deacon's automation system
when the cooldown gate elapses (default: 1h). Configured as an automation in
`formulas/automations/wisp-compact/automation.toml`.

Wisps are short-lived work items (heartbeats, pings, patrols) that
accumulate and bloat the database. This formula applies retention policy:
- Closed wisps past TTL → deleted (Dolt AS OF preserves history)
- Non-closed wisps past TTL → promoted to permanent (stuck detection)
- Wisps with comments or "keep" label → always promoted (proven value)

No pool dispatch — the deacon runs this itself as a maintenance task."""
formula = "mol-wisp-compact"
version = 2

[[steps]]
id = "compact"
title = "Compact expired wisps"
description = """
Run TTL-based wisp compaction using raw bd commands.

**TTL policy** (by wisp_type label):
- heartbeat, ping: 6h
- patrol, gc_report: 24h
- recovery, error, escalation: 7d
- default (untyped): 24h

**Step 1: List all ephemeral beads**
```bash
bd list --json --all -n 0 2>/dev/null
```

Filter the JSON output to only ephemeral beads (where `ephemeral: true`).

**Step 2: For each expired wisp, apply policy**

Calculate age from `updated_at` (or `created_at` if no update). Look up
TTL from the wisp_type label (e.g., `wisp_type:heartbeat`). If no
wisp_type label, use the 24h default.

For each wisp past its TTL:

- **If it has comments (`comment_count > 0`) or a `keep` label → promote:**
  ```bash
  bd update <id> --persistent
  bd comment <id> "Promoted from wisp: proven value"
  ```

- **If closed → delete** (safe — Dolt AS OF preserves history):
  ```bash
  bd delete <id> --force
  ```

- **If not closed → promote** (something is stuck):
  ```bash
  bd update <id> --persistent
  bd comment <id> "Promoted from wisp: open past TTL (stuck detection)"
  ```

**Step 3: Log summary**
Note the counts: promoted N, deleted N, skipped N (within TTL).
If nothing to compact, log that and close the step.

**Exit criteria:** All expired wisps processed (or nothing to compact)."""

[[steps]]
id = "compact-report"
title = "Send compaction digest"
needs = ["compact"]
description = """
Send a digest of compaction results to the mayor.

**Step 1: Summarize results**
Compile the promoted/deleted/skipped counts from the compact step.
Include any anomalies:
- High promotion count (>5) may indicate stuck agents
- Any non-closed wisps promoted should be flagged

**Step 2: Send digest** (if there was activity)
```bash
gc mail send --to mayor --subject "Wisp compaction digest" --body "<summary>"
```

Skip the digest if nothing was compacted (promoted + deleted == 0).

**Exit criteria:** Digest sent (or nothing to report)."""
