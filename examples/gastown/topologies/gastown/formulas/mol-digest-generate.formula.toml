description = """
Generate activity digest for the mayor.

This is a **periodic formula** — dispatched by the deacon's
`periodic-formulas` step when the cooldown gate elapses. Configured
in `city.toml` under `[formulas]`:

```toml
[[formulas.periodic]]
formula = "mol-digest-generate"
gate = "cooldown"
interval = "24h"
pool = "dog"
```

The deacon checks if enough time has passed since the last run
(tracked via `type:plugin-run` beads), pours a wisp, and labels it
for the dog pool. A dog picks it up and runs this formula.

## What it produces

A formatted markdown digest covering:
- Issues filed and closed (by rig, by type)
- Merge activity
- Incidents and escalations
- Agent health summary
- Trends (backlog direction, throughput)

The digest is mailed to the mayor and archived as a digest bead.

Read each step's description before acting — Config values override defaults."""
formula = "mol-digest-generate"
version = 2

[vars]
[vars.period]
description = "The digest period type (daily, weekly)"
default = "daily"

[vars.event_timeout]
description = "Seconds to wait for slow queries before giving up"
default = "30"

[[steps]]
id = "determine-period"
title = "Determine digest time range"
description = """
Establish the time range for this digest.

**1. Determine period type:**
Use {{period}} (from formula vars, defaults to "daily").

**2. Calculate time range:**

| Period | Since | Until |
|--------|-------|-------|
| daily | Yesterday 00:00 UTC | Today 00:00 UTC |
| weekly | Last Monday 00:00 UTC | This Monday 00:00 UTC |

```bash
# For daily:
SINCE=$(date -u -d 'yesterday 00:00' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || \
        date -u -v-1d -j -f '%H:%M' '00:00' +%Y-%m-%dT%H:%M:%SZ)
UNTIL=$(date -u -d 'today 00:00' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || \
        date -u -j -f '%H:%M' '00:00' +%Y-%m-%dT%H:%M:%SZ)
```

Note the timestamps for the digest header.

Close this step when the time range is established."""

[[steps]]
id = "collect-data"
title = "Collect activity data from all rigs"
needs = ["determine-period"]
description = """
Gather activity data from each rig.

**1. List rigs:**
```bash
gc rig list
```

**2. For each rig, collect:**

a) **Issues filed and closed:**
```bash
bd list --created-after=$SINCE --json --limit=0
bd list --status=closed --closed-after=$SINCE --json --limit=0
```

b) **Merge activity:**
```bash
git -C <rig-path> log --merges --since=$SINCE --oneline main
```

c) **Incidents:**
```bash
bd list --label=incident --created-after=$SINCE --json
```

**3. Collect town-level data:**

a) **Agent events:**
```bash
gc events --since=$SINCE --type=agent.started,agent.stopped,agent.crashed --json
```

b) **Escalations:**
```bash
bd list --label=escalation --created-after=$SINCE --json
```

c) **Warrants filed:**
```bash
bd list --type=warrant --created-after=$SINCE --json
```

Close this step when all data is collected."""

[[steps]]
id = "generate-and-send"
title = "Generate digest, send to mayor, archive"
needs = ["collect-data"]
description = """
Transform data into a formatted digest and deliver it.

**1. Generate digest markdown:**

```markdown
# Gas Town {{period}} Digest: {{date}}

## Summary
- **Issues filed**: N (tasks: X, bugs: Y)
- **Issues closed**: N
- **Net change**: +/-N

## By Rig
| Rig | Filed | Closed | Merges |
|-----|-------|--------|--------|
| ... | ...   | ...    | ...    |

## Highlights
- Notable completions
- Incidents (if any)

## Agent Health
- Agents started/stopped/crashed: N/N/N
- Warrants filed: N (pardoned: X, executed: Y)

## Trends
- Backlog: increasing / stable / decreasing
- Throughput: N issues/day
```

**2. Send to mayor:**
```bash
gc mail send mayor/ -s "Gas Town Digest: $DATE" -m "$DIGEST"
```

**3. Archive as bead:**
```bash
bd create --type=digest \
  --title="Digest: $DATE" \
  --label=digest,{{period}}
```

**4. Close work bead and exit:**
```bash
bd close <work-bead> --reason "Digest generated and sent"
exit
```

The deacon records this run via a `type:plugin-run` bead for cooldown
tracking on the next patrol cycle."""
