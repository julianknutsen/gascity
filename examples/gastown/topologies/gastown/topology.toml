# Gas Town — domain-specific coding workflow topology.
#
# Gastown roles: mayor (coordinator), deacon (patrol), boot (watchdog),
# plus rig-scoped agents (witness, refinery, polecat).
# Dog (utility pool) and mechanical housekeeping live in the maintenance
# topology — include both for full Gas Town.
#
# Referenced by both workspace.topology and rigs[].topology:
#   workspace.topology → expands city_agents only (mayor, deacon, boot)
#   rigs[].topology    → expands rig agents only (witness, refinery, polecat)
#
# Crew members are individually named and declared inline in city.toml.

[topology]
name = "gastown"
schema = 1
includes = ["../maintenance"]
city_agents = ["mayor", "deacon", "boot", "dog"]

[formulas]
dir = "formulas"

# ── MAYOR — Global coordinator. One per city. ──────────────────────────
[[agents]]
name = "mayor"
prompt_template = "prompts/mayor.md.tmpl"
nudge = "Check mail and hook status, then act accordingly."
overlay_dir = "overlays/default"
idle_timeout = "1h"
session_setup = [
    "tmux set-option -t {{.Session}} status-right-length 80",
    "tmux set-option -t {{.Session}} status-interval 5",
    "tmux set-option -t {{.Session}} status-right '#({{.ConfigDir}}/scripts/status-line.sh {{.Agent}}) %H:%M'",
    "{{.ConfigDir}}/scripts/bind-key.sh n \"run-shell '{{.ConfigDir}}/scripts/cycle.sh next #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh p \"run-shell '{{.ConfigDir}}/scripts/cycle.sh prev #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh g \"run-shell '{{.ConfigDir}}/scripts/agent-menu.sh #{client_tty}'\"",
]

# ── DEACON — Daemon beacon / patrol executor. One per city. ────────────
[[agents]]
name = "deacon"
prompt_template = "prompts/deacon.md.tmpl"
nudge = "Run 'gc prime' to check patrol status and begin heartbeat cycle."
overlay_dir = "overlays/default"
idle_timeout = "1h"
session_setup = [
    "tmux set-option -t {{.Session}} status-right-length 80",
    "tmux set-option -t {{.Session}} status-interval 5",
    "tmux set-option -t {{.Session}} status-right '#({{.ConfigDir}}/scripts/status-line.sh {{.Agent}}) %H:%M'",
    "{{.ConfigDir}}/scripts/bind-key.sh n \"run-shell '{{.ConfigDir}}/scripts/cycle.sh next #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh p \"run-shell '{{.ConfigDir}}/scripts/cycle.sh prev #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh g \"run-shell '{{.ConfigDir}}/scripts/agent-menu.sh #{client_tty}'\"",
]

# ── BOOT — Deacon watchdog. Ephemeral. ─────────────────────────────────
[[agents]]
name = "boot"
prompt_template = "prompts/boot.md.tmpl"
overlay_dir = "overlays/default"

# ── WITNESS — per-rig worker monitor. Singleton. ──────────────────────
[[agents]]
name = "witness"
prompt_template = "prompts/witness.md.tmpl"
nudge = "Run 'gc prime' to check worker status and begin patrol cycle."
overlay_dir = "overlays/witness"
idle_timeout = "1h"
session_setup = [
    "tmux set-option -t {{.Session}} status-right-length 80",
    "tmux set-option -t {{.Session}} status-interval 5",
    "tmux set-option -t {{.Session}} status-right '#({{.ConfigDir}}/scripts/status-line.sh {{.Agent}}) %H:%M'",
    "{{.ConfigDir}}/scripts/bind-key.sh n \"run-shell '{{.ConfigDir}}/scripts/cycle.sh next #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh p \"run-shell '{{.ConfigDir}}/scripts/cycle.sh prev #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh g \"run-shell '{{.ConfigDir}}/scripts/agent-menu.sh #{client_tty}'\"",
]

# ── REFINERY — merge queue processor. Singleton. Worktree. ─────────────
[[agents]]
name = "refinery"
prompt_template = "prompts/refinery.md.tmpl"
nudge = "Run 'gc prime' to check merge queue and begin processing."
overlay_dir = "overlays/default"
pre_start = ["{{.ConfigDir}}/scripts/worktree-setup.sh {{.WorkDir}} {{.Agent}} {{.CityRoot}} --sync"]
idle_timeout = "2h"
session_setup = [
    "tmux set-option -t {{.Session}} status-right-length 80",
    "tmux set-option -t {{.Session}} status-interval 5",
    "tmux set-option -t {{.Session}} status-right '#({{.ConfigDir}}/scripts/status-line.sh {{.Agent}}) %H:%M'",
    "{{.ConfigDir}}/scripts/bind-key.sh n \"run-shell '{{.ConfigDir}}/scripts/cycle.sh next #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh p \"run-shell '{{.ConfigDir}}/scripts/cycle.sh prev #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh g \"run-shell '{{.ConfigDir}}/scripts/agent-menu.sh #{client_tty}'\"",
]

# ── POLECAT — transient workers. Pool. Worktree. ──────────────────────
[[agents]]
name = "polecat"
prompt_template = "prompts/polecat.md.tmpl"
nudge = "Check your hook for work assignments."
overlay_dir = "overlays/default"
pre_start = ["{{.ConfigDir}}/scripts/worktree-setup.sh {{.WorkDir}} {{.Agent}} {{.CityRoot}} --sync"]
idle_timeout = "2h"
session_setup = [
    "tmux set-option -t {{.Session}} status-right-length 80",
    "tmux set-option -t {{.Session}} status-interval 5",
    "tmux set-option -t {{.Session}} status-right '#({{.ConfigDir}}/scripts/status-line.sh {{.Agent}}) %H:%M'",
    "{{.ConfigDir}}/scripts/bind-key.sh n \"run-shell '{{.ConfigDir}}/scripts/cycle.sh next #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh p \"run-shell '{{.ConfigDir}}/scripts/cycle.sh prev #{session_name} #{client_tty}'\"",
    "{{.ConfigDir}}/scripts/bind-key.sh g \"run-shell '{{.ConfigDir}}/scripts/agent-menu.sh #{client_tty}'\"",
]
[agents.pool]
min = 0
max = 5
