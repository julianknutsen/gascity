# Gas Town — rig topology.
#
# Stamped once per [[rigs]] entry with topology = "topologies/rig".
# Each agent gets dir = <rig-name> automatically.
#
# Path conventions:
#   prompt_template, overlay_dir  — "//" resolves to city root (adjustFragmentPath)
#   session_setup, pre_start      — Go templates; {{.CityRoot}} = city root at runtime

[topology]
name = "gastown-rig"
schema = 1

# ── WITNESS — per-rig worker monitor. Singleton. ──────────────────────
[[agents]]
name = "witness"
prompt_template = "//prompts/witness.md.tmpl"
nudge = "Run 'gc prime' to check worker status and begin patrol cycle."
overlay_dir = "//overlays/witness"
idle_timeout = "1h"
session_setup = [
    "tmux set-option -t {{.Session}} status-right-length 80",
    "tmux set-option -t {{.Session}} status-interval 5",
    "tmux set-option -t {{.Session}} status-right '#({{.CityRoot}}/scripts/status-line.sh {{.Agent}}) %H:%M'",
    "{{.CityRoot}}/scripts/bind-key.sh n \"run-shell '{{.CityRoot}}/scripts/cycle.sh next #{session_name} #{client_tty}'\"",
    "{{.CityRoot}}/scripts/bind-key.sh p \"run-shell '{{.CityRoot}}/scripts/cycle.sh prev #{session_name} #{client_tty}'\"",
    "{{.CityRoot}}/scripts/bind-key.sh g \"run-shell '{{.CityRoot}}/scripts/agent-menu.sh #{client_tty}'\"",
]

# ── REFINERY — merge queue processor. Singleton. ──────────────────────
[[agents]]
name = "refinery"
dir = ".gc/worktrees/{{.Rig}}/refinery"
prompt_template = "//prompts/refinery.md.tmpl"
nudge = "Run 'gc prime' to check merge queue and begin processing."
overlay_dir = "//overlays/default"
idle_timeout = "2h"
pre_start = [
    "{{.CityRoot}}/scripts/worktree-setup.sh {{.CityRoot}}/{{.Rig}} {{.Agent}} {{.CityRoot}} --sync",
]
session_setup = [
    "tmux set-option -t {{.Session}} status-right-length 80",
    "tmux set-option -t {{.Session}} status-interval 5",
    "tmux set-option -t {{.Session}} status-right '#({{.CityRoot}}/scripts/status-line.sh {{.Agent}}) %H:%M'",
    "{{.CityRoot}}/scripts/bind-key.sh n \"run-shell '{{.CityRoot}}/scripts/cycle.sh next #{session_name} #{client_tty}'\"",
    "{{.CityRoot}}/scripts/bind-key.sh p \"run-shell '{{.CityRoot}}/scripts/cycle.sh prev #{session_name} #{client_tty}'\"",
    "{{.CityRoot}}/scripts/bind-key.sh g \"run-shell '{{.CityRoot}}/scripts/agent-menu.sh #{client_tty}'\"",
]

# ── POLECAT — transient workers. Pool. ─────────────────────
[[agents]]
name = "polecat"
dir = ".gc/worktrees/{{.Rig}}/{{.Agent}}"
prompt_template = "//prompts/polecat.md.tmpl"
nudge = "Check your hook for work assignments."
overlay_dir = "//overlays/default"
idle_timeout = "2h"
pre_start = [
    "{{.CityRoot}}/scripts/worktree-setup.sh {{.CityRoot}}/{{.Rig}} {{.Agent}} {{.CityRoot}} --sync",
]
session_setup = [
    "tmux set-option -t {{.Session}} status-right-length 80",
    "tmux set-option -t {{.Session}} status-interval 5",
    "tmux set-option -t {{.Session}} status-right '#({{.CityRoot}}/scripts/status-line.sh {{.Agent}}) %H:%M'",
    "{{.CityRoot}}/scripts/bind-key.sh n \"run-shell '{{.CityRoot}}/scripts/cycle.sh next #{session_name} #{client_tty}'\"",
    "{{.CityRoot}}/scripts/bind-key.sh p \"run-shell '{{.CityRoot}}/scripts/cycle.sh prev #{session_name} #{client_tty}'\"",
    "{{.CityRoot}}/scripts/bind-key.sh g \"run-shell '{{.CityRoot}}/scripts/agent-menu.sh #{client_tty}'\"",
]
[agents.pool]
min = 0
max = 5
check = "bd list --label=pool:polecat --status=open --json 2>/dev/null | jq length 2>/dev/null || echo 0"
