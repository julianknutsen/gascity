# RBAC for the Gas City controller pod.
#
# The controller manages agent pods via kubectl (through gc-session-k8s).
# It needs permissions to create, delete, list, get, and exec into pods,
# read pod logs for diagnostics, and manage ConfigMaps for the events
# provider (gc-events-k8s) and beads provider (gc-beads-k8s).
#
# Apply: kubectl apply -f contrib/k8s/controller-rbac.yaml
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gc-controller
  namespace: gc
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gc-controller
  namespace: gc
rules:
  # Pod lifecycle — create, update, delete agent pods.
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Pod exec — run commands inside agent containers (nudge, peek, meta).
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
  # Pod logs — diagnostics and debugging.
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]
  # ConfigMaps — gc-events-k8s stores events as ConfigMaps,
  # gc-beads-k8s stores beads as ConfigMaps.
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gc-controller
  namespace: gc
subjects:
  - kind: ServiceAccount
    name: gc-controller
    namespace: gc
roleRef:
  kind: Role
  name: gc-controller
  apiGroup: rbac.authorization.k8s.io
