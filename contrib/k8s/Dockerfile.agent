# Gas City agent container image — binary layer.
#
# Built on top of gc-agent-base (Dockerfile.base) which has all system
# dependencies. This layer only copies project binaries, so rebuilds
# after code changes take ~5s instead of ~2.5 min.
#
# Build:
#   make docker-agent
#   # or: docker build -f contrib/k8s/Dockerfile.agent -t gc-agent:latest .
#
# Full rebuild (base + agent):
#   make docker-base docker-agent
#
# The gc binary should be built first and placed in the build context root:
#   go build -o gc ./cmd/gc

ARG BASE_IMAGE=gc-agent-base:latest
FROM ${BASE_IMAGE}

# bd (beads) CLI — copied from build context.
# Build with: cp $(which bd) . && docker build ...
COPY bd /usr/local/bin/bd

# br (beads_rust) CLI — copied from build context.
# Build with: cp $(which br) . && docker build ...
COPY br /usr/local/bin/br

# gc binary — copied from build context.
COPY gc /usr/local/bin/gc

# gc-beads-br script for the exec:beads protocol.
COPY contrib/beads-scripts/gc-beads-br /usr/local/bin/gc-beads-br

# Claude credentials are injected at runtime via K8s Secret volume mount,
# not baked into the image. See contrib/k8s/README-credentials.md.
# The CLAUDE_CONFIG_DIR env var (set by gc-session-k8s) points to the mount.

WORKDIR /workspace
RUN chown gcagent:gcagent /workspace

USER gcagent

CMD ["/bin/bash"]
