# Event cleanup CronJob â€” prune old event ConfigMaps.
#
# Events are stored as ConfigMaps (gc-evt-NNNNNNNNNN) with label
# gc/component=event. At 100 agents, thousands accumulate over days,
# slowing list operations and bloating etcd.
#
# This job deletes event ConfigMaps older than 24 hours every 6 hours.
# Uses the gc-controller ServiceAccount which already has configmap RBAC.

apiVersion: batch/v1
kind: CronJob
metadata:
  name: gc-event-cleanup
  namespace: gc
  labels:
    app: gc-event-cleanup
    app.kubernetes.io/part-of: gas-city
spec:
  schedule: "0 */6 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      activeDeadlineSeconds: 300
      template:
        spec:
          serviceAccountName: gc-controller
          restartPolicy: Never
          containers:
          - name: cleanup
            image: bitnami/kubectl:latest
            command:
            - sh
            - -c
            - |
              cutoff=$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null \
                || date -u -v-24H +%Y-%m-%dT%H:%M:%SZ)
              echo "Pruning event ConfigMaps created before $cutoff..."
              kubectl -n gc get configmaps -l gc/component=event \
                -o json | jq -r --arg cutoff "$cutoff" \
                '.items[] | select(.metadata.creationTimestamp < $cutoff) | .metadata.name' \
              | while read -r name; do
                  echo "  deleting $name"
                  kubectl -n gc delete configmap "$name"
                done
              echo "Done."
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 128Mi
